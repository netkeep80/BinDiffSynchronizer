# BinDiffSynchronizer — Персистная инфраструктура

Библиотека на C++17 для построения персистных структур данных на основе единого персистного адресного пространства (ПАП).

---

## Обзор

Проект реализует персистную инфраструктуру, позволяющую хранить объекты произвольных типов в едином бинарном файле-образе и восстанавливать их между перезапусками без вызова конструкторов.

Конечная цель — реализация `pjson`, персистного аналога `nlohmann::json`.

---

## Архитектура

### Требования

| №     | Требование |
|-------|------------|
| Тр.1  | Персистные объекты используют только персистные указатели |
| Тр.2  | Создание/удаление объектов — через специальные методы аллокатора |
| Тр.3  | При запуске аллокатор инициализируется именем файла-хранилища |
| Тр.4  | Единое ПАП для объектов разных типов |
| Тр.5  | `sizeof(fptr<T>) == sizeof(void*)` |
| Тр.6  | Все комментарии — на русском языке |
| Тр.7  | Никакой логики с именами файлов в `persist<T>` |
| Тр.8  | `sizeof(persist<T>) == sizeof(T)` |
| Тр.9  | Никакой логики с именами файлов в `fptr<T>` |
| Тр.10 | При загрузке образа ПАП конструкторы/деструкторы не вызываются |
| Тр.11 | Объекты `persist<T>` живут только в образе ПАП |
| Тр.12 | Доступ к персистным объектам — только через `fptr<T>` |
| Тр.13 | `fptr<T>` может находиться как в обычной памяти, так и в ПАП |
| Тр.14 | ПАМ — персистный объект, хранит имена объектов |
| Тр.15 | `fptr<T>` инициализируется строковым именем объекта через ПАМ |
| Тр.16 | ПАМ хранит карту объектов и их имена |

---

## Файлы проекта

| Файл | Описание |
|------|----------|
| `pam_core.h` | Ядро персистного адресного менеджера (ПАМ): `PersistentAddressSpace`, вектор типов, карта слотов, карта имён, список свободных областей (reuse), `Realloc` |
| `pam.h` | Надстройка над `pam_core.h`: включает `pvector`, `pmap`, `pstring` |
| `persist.h` | Базовые типы: `persist<T>`, `fptr<T>`, `AddressManager<T>` |
| `pvector.h` | Персистный динамический массив `pvector<T>` (аналог `std::vector`) |
| `pmap.h` | Персистная карта `pmap<K,V>` (аналог `std::map`, sorted array) |
| `pstring.h` | Персистная строка `pstring` (аналог `std::string`) |
| `pjson.h` | Персистный JSON `pjson` (аналог `nlohmann::json`) |
| `pallocator.h` | STL-совместимый аллокатор `pallocator<T>` поверх ПАМ |
| `main.cpp` | Демонстрационная программа |
| `tests/` | Тесты на Catch2: ПАМ, pvector, pmap, pstring, pjson, pallocator, производительность |
| `CMakeLists.txt` | Система сборки (CMake 3.14+, C++17) |

### Структура файла ПАМ (версия 9)

```
[pam_header]          — заголовок (magic, version, offsets структур, bump)
[данные ПАП]          — область данных:
  [type_vec]          — вектор типов TypeInfo (pvector<TypeInfo>)
  [slot_map]          — карта слотов pmap<uintptr_t, SlotInfo>
  [name_map]          — карта имён pmap<name_key, uintptr_t>
  [free_list]         — список свободных областей для reuse
  [объекты]           — пользовательские данные
```

### Управление памятью

- **Bump-allocator**: новые объекты выделяются линейно в конце ПАП.
- **Список свободных областей (free_list)**: при удалении объекта (`Delete`) его область данных добавляется в список свободных. При следующем выделении сначала ищется подходящая свободная область (first-fit), что обеспечивает повторное использование памяти без роста файла.
- **Realloc**: `pvector::grow` и `pmap::grow` используют `PersistentAddressSpace::Realloc()` — если расширяемый блок является последним в ПАП, он расширяется на месте без копирования данных.

### Оптимизация массовых операций

- **`ReserveSlots(n)`**: предварительно резервирует ёмкость карты слотов ПАМ не менее `n` записей за один вызов. Устраняет многократные реаллокации при массовом добавлении объектов (например, при разборе большого JSON). Вызывать перед `pjson::from_string()` для файлов с >10 000 узлов.
- **`Reset()`**: сбрасывает ПАМ к пустому состоянию за O(1) — быстрее поэлементного удаления 100k+ объектов (O(n²)). Используется в тестах для очистки после обработки большого JSON вместо `free()`/`Delete()` на каждом узле.

---

## Сборка и тестирование

```bash
cmake -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build
ctest --test-dir build --output-on-failure
```

---

## Лицензия

Unlicense — общественное достояние. Подробности в файле `LICENSE`.
